// PaintPro Database Schema
// Prisma schema for painting business management system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER AUTHENTICATION
// ============================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  role         UserRole  @default(user)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  sessions Session[]

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

enum UserRole {
  admin
  user
  viewer
}

// ============================================
// BUSINESS SETTINGS
// ============================================

model BusinessSettings {
  id                     String   @id @default(cuid())
  subPayoutPct           Float    @default(60)
  subMaterialsPct        Float    @default(15)
  subLaborPct            Float    @default(45)
  minGrossProfitPerJob   Float    @default(900)
  targetGrossMarginPct   Float    @default(40)
  defaultDepositPct      Float    @default(30)
  arTargetDays           Int      @default(7)
  priceRoundingIncrement Float    @default(50)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

// ============================================
// TEAM & SUBCONTRACTORS
// ============================================

model TeamMember {
  id                   String   @id @default(cuid())
  name                 String
  email                String   @unique
  phone                String?
  role                 TeamRole @default(both)
  defaultCommissionPct Float    @default(5)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  salesJobs     Job[]  @relation("SalesRep")
  pmJobs        Job[]  @relation("ProjectManager")
  assignedLeads Lead[]
}

enum TeamRole {
  sales
  pm
  both
}

model Subcontractor {
  id               String             @id @default(cuid())
  name             String
  companyName      String?
  email            String             @unique
  phone            String?
  specialty        SubcontractorType  @default(both)
  defaultPayoutPct Float              @default(60)
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  // Relations
  jobs Job[]
}

enum SubcontractorType {
  interior
  exterior
  both
}

// ============================================
// LEADS / CRM
// ============================================

model Lead {
  id                 String      @id @default(cuid())
  firstName          String
  lastName           String
  email              String
  phone              String
  address            String
  city               String
  state              String
  zipCode            String
  source             String
  status             LeadStatus  @default(new)
  projectType        ProjectType @default(interior)
  leadDate           DateTime    @default(now())
  nextFollowupDate   DateTime?
  estimatedJobValue  Float?
  wonLostReason      String?
  notes              String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  // Relations
  assignedToId String?
  assignedTo   TeamMember? @relation(fields: [assignedToId], references: [id])
  estimates    Estimate[]
  jobs         Job[]

  @@index([status])
  @@index([leadDate])
}

enum LeadStatus {
  new
  contacted
  estimate_scheduled
  estimated
  proposal_sent
  follow_up
  won
  lost
}

enum ProjectType {
  interior
  exterior
  both
}

// ============================================
// ESTIMATES
// ============================================

model Estimate {
  id              String         @id @default(cuid())
  estimateNumber  String         @unique
  clientName      String
  address         String
  status          EstimateStatus @default(draft)
  estimateDate    DateTime       @default(now())
  validUntil      DateTime
  subtotal        Float          @default(0)
  discountAmount  Float          @default(0)
  totalPrice      Float          @default(0)
  subMaterialsCost Float         @default(0)
  subLaborCost    Float          @default(0)
  subTotalCost    Float          @default(0)
  grossProfit     Float          @default(0)
  grossMarginPct  Float          @default(0)
  meetsMinGp      Boolean        @default(false)
  meetsTargetGm   Boolean        @default(false)
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  leadId     String?
  lead       Lead?              @relation(fields: [leadId], references: [id])
  lineItems  EstimateLineItem[]
  signature  EstimateSignature?
  job        Job?

  @@index([status])
  @@index([estimateDate])
}

enum EstimateStatus {
  draft
  sent
  viewed
  accepted
  declined
  expired
}

model EstimateLineItem {
  id          String  @id @default(cuid())
  description String
  location    String
  scope       Scope?
  quantity    Int     @default(1)
  unitPrice   Float
  lineTotal   Float

  // Relations
  estimateId String
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
}

enum Scope {
  walls_only
  walls_trim
  walls_trim_ceiling
  full_refresh
}

model EstimateSignature {
  id               String   @id @default(cuid())
  clientName       String
  signatureDataUrl String   @db.Text
  signedAt         DateTime @default(now())
  ipAddress        String?

  // Relations
  estimateId String   @unique
  estimate   Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
}

// ============================================
// JOBS
// ============================================

model Job {
  id                 String      @id @default(cuid())
  jobNumber          String      @unique
  clientName         String
  address            String
  city               String
  projectType        ProjectType @default(interior)
  status             JobStatus   @default(lead)
  jobDate            DateTime    @default(now())
  scheduledStartDate DateTime?
  scheduledEndDate   DateTime?
  actualStartDate    DateTime?
  actualEndDate      DateTime?

  // Job Value (drives all calculations)
  jobValue Float @default(0)

  // Auto-calculated from job value
  subMaterials    Float @default(0)
  subLabor        Float @default(0)
  subTotal        Float @default(0)
  grossProfit     Float @default(0)
  grossMarginPct  Float @default(0)

  // Client Payment Tracking
  depositRequired     Float    @default(0)
  depositPaid         Boolean  @default(false)
  jobPaid             Boolean  @default(false)
  balanceDue          Float    @default(0)
  invoiceDate         DateTime?
  paymentReceivedDate DateTime?
  daysToCollect       Int?

  // Sales Commission
  salesCommissionPct    Float   @default(0)
  salesCommissionAmount Float   @default(0)
  salesCommissionPaid   Boolean @default(false)

  // PM Commission
  pmCommissionPct    Float   @default(0)
  pmCommissionAmount Float   @default(0)
  pmCommissionPaid   Boolean @default(false)

  // Subcontractor Payment
  subcontractorPrice Float   @default(0)
  subcontractorPaid  Boolean @default(false)

  // Profit Flags
  meetsMinGp     Boolean    @default(false)
  meetsTargetGm  Boolean    @default(false)
  profitFlag     ProfitFlag @default(OK)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  leadId          String?
  lead            Lead?          @relation(fields: [leadId], references: [id])
  estimateId      String?        @unique
  estimate        Estimate?      @relation(fields: [estimateId], references: [id])
  salesRepId      String?
  salesRep        TeamMember?    @relation("SalesRep", fields: [salesRepId], references: [id])
  projectManagerId String?
  projectManager  TeamMember?    @relation("ProjectManager", fields: [projectManagerId], references: [id])
  subcontractorId String?
  subcontractor   Subcontractor? @relation(fields: [subcontractorId], references: [id])
  reviews         Review[]

  @@index([status])
  @@index([jobDate])
}

enum JobStatus {
  lead
  got_the_job
  scheduled
  completed
}

enum ProfitFlag {
  OK
  RAISE_PRICE
  FIX_SCOPE
}

// ============================================
// PRICE BOOK
// ============================================

model RoomPrice {
  id               String @id @default(cuid())
  roomType         String
  size             String
  typicalSqft      Int
  wallsOnly        Float
  wallsTrim        Float
  wallsTrimCeiling Float
  fullRefresh      Float
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([roomType, size])
}

model ExteriorPrice {
  id             String @id @default(cuid())
  surfaceType    String @unique
  pricePerSqft   Float
  prepMultiplier Float  @default(1.0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Addon {
  id        String      @id @default(cuid())
  name      String      @unique
  category  AddonCategory @default(both)
  unit      String
  basePrice Float
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

enum AddonCategory {
  interior
  exterior
  both
}

// ============================================
// EOS / TRACTION
// ============================================

model VTO {
  id               String   @id @default(cuid())
  coreValues       String[] @default([])
  coreFocusPurpose String   @default("")
  coreFocusNiche   String   @default("")
  tenYearTarget    String   @default("")
  threeYearRevenue Float    @default(0)
  threeYearProfit  Float    @default(0)
  threeYearPicture String   @default("")
  oneYearRevenue   Float    @default(0)
  oneYearProfit    Float    @default(0)
  oneYearGoals     String[] @default([])
  targetMarket     String   @default("")
  threeUniques     String[] @default([])
  provenProcess    String   @default("")
  guarantee        String   @default("")
  longTermIssues   String[] @default([])
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Rock {
  id          String     @id @default(cuid())
  title       String
  description String?
  owner       String
  rockType    RockType   @default(individual)
  quarter     Int
  year        Int
  status      RockStatus @default(on_track)
  dueDate     DateTime
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([quarter, year])
  @@index([owner])
}

enum RockType {
  company
  individual
}

enum RockStatus {
  on_track
  off_track
  complete
  dropped
}

model Todo {
  id        String     @id @default(cuid())
  title     String
  owner     String
  dueDate   DateTime
  status    TodoStatus @default(pending)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([owner])
  @@index([status])
}

enum TodoStatus {
  pending
  done
}

model Issue {
  id          String        @id @default(cuid())
  title       String
  description String?
  issueType   IssueType     @default(short_term)
  priority    Int           @default(2)
  status      IssueStatus   @default(open)
  createdBy   String
  resolution  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([issueType])
  @@index([status])
}

enum IssueType {
  short_term
  long_term
}

enum IssueStatus {
  open
  in_discussion
  solved
}

model Seat {
  id                    String   @id @default(cuid())
  seatName              String
  roleDescription       String
  responsibilities      String[] @default([])
  personName            String?
  personId              String?
  reportsToId           String?
  reportsTo             Seat?    @relation("SeatHierarchy", fields: [reportsToId], references: [id])
  directReports         Seat[]   @relation("SeatHierarchy")
  gwcGetsIt             Boolean  @default(true)
  gwcWantsIt            Boolean  @default(true)
  gwcCapacity           Boolean  @default(true)
  isRightPersonRightSeat Boolean @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Meeting {
  id          String      @id @default(cuid())
  meetingDate DateTime
  meetingType MeetingType @default(l10)
  attendees   String[]    @default([])
  ratingAvg   Float       @default(0)
  segueNotes  String?
  headlines   String?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([meetingDate])
}

enum MeetingType {
  l10
  quarterly
  annual
}

model ScorecardMetric {
  id        String           @id @default(cuid())
  name      String
  owner     String
  goalValue Float
  goalType  GoalType         @default(number)
  goalDirection GoalDirection @default(above)
  category  MetricCategory   @default(leading)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  entries ScorecardEntry[]

  @@index([owner])
}

enum GoalType {
  number
  currency
  percent
}

enum GoalDirection {
  above
  below
}

enum MetricCategory {
  leading
  lagging
}

model ScorecardEntry {
  id             String   @id @default(cuid())
  weekEndingDate DateTime
  actualValue    Float
  onTrack        Boolean  @default(false)
  createdAt      DateTime @default(now())

  metricId String
  metric   ScorecardMetric @relation(fields: [metricId], references: [id], onDelete: Cascade)

  @@unique([metricId, weekEndingDate])
  @@index([weekEndingDate])
}

model PeopleAnalyzer {
  id               String   @id @default(cuid())
  personName       String
  personId         String
  reviewDate       DateTime @default(now())
  coreValueRatings Json     @default("{}")
  gwcGetsIt        Boolean  @default(true)
  gwcWantsIt       Boolean  @default(true)
  gwcCapacity      Boolean  @default(true)
  overallStatus    PersonStatus @default(right_person_right_seat)
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([personId])
}

enum PersonStatus {
  right_person_right_seat
  needs_work
  wrong_fit
}

// ============================================
// COMPANY SETTINGS FOR ESTIMATES
// ============================================

model CompanyEstimateSettings {
  id                      String   @id @default(cuid())

  // Insurance
  insuranceCertificateUrl String?
  insuranceCompany        String?
  insurancePolicyNumber   String?
  insuranceCoverageAmount Float?
  insuranceExpirationDate DateTime?

  // License
  licenseImageUrl         String?
  licenseNumber           String?
  licenseState            String?
  licenseExpirationDate   DateTime?

  // Terms & Conditions
  termsAndConditions      String   @default("")
  paymentTerms            String?
  warrantyTerms           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PortfolioImage {
  id          String      @id @default(cuid())
  beforeUrl   String
  afterUrl    String
  projectType ProjectType @default(interior)
  description String?
  createdAt   DateTime    @default(now())
}

// ============================================
// AI ASSISTANT
// ============================================

model AIConversation {
  id        String      @id @default(cuid())
  sessionId String
  createdAt DateTime    @default(now())

  messages  AIMessage[]

  @@index([sessionId])
}

model AIMessage {
  id                    String   @id @default(cuid())
  role                  AIRole
  content               String   @db.Text
  suggestedLineItems    Json?
  suggestedRiskModifiers String[] @default([])
  createdAt             DateTime @default(now())

  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

enum AIRole {
  user
  assistant
}

// ============================================
// KPI TRACKING & FINANCIAL PLANNING
// ============================================

model MarketingSpend {
  id        String   @id @default(cuid())
  source    String   // Google PPC, Facebook, Yard Sign, Referral, etc.
  amount    Float
  month     Int      // 1-12
  year      Int
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([month, year, source])
  @@index([year, month])
}

model SeasonalCurve {
  id        String   @id @default(cuid())
  month     Int      // 1-12
  metric    String   // leads, issues, sales, revenue
  weight    Float    // Percentage weight (0.05 = 5%)
  year      Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([month, year, metric])
  @@index([year])
}

model DailyTarget {
  id                  String   @id @default(cuid())
  date                DateTime @db.Date
  dayWeight           Float    @default(1) // 0=Sun, 1=Sat, 2=Weekday
  isHoliday           Boolean  @default(false)
  holidayName         String?

  // Goals
  leadsGoal           Float    @default(0)
  appointmentsGoal    Float    @default(0)
  salesGoal           Float    @default(0)
  salesValueGoal      Float    @default(0)
  revenueGoal         Float    @default(0)
  reviewsGoal         Float    @default(0)

  // Actuals
  leadsActual         Int      @default(0)
  appointmentsActual  Int      @default(0)
  salesActual         Int      @default(0)
  salesValueActual    Float    @default(0)
  revenueActual       Float    @default(0)
  reviewsActual       Int      @default(0)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([date])
  @@index([date])
}

model MonthlyTarget {
  id                  String   @id @default(cuid())
  month               Int      // 1-12
  year                Int
  quarter             Int      // 1-4

  // Goals
  leadsGoal           Int      @default(0)
  appointmentsGoal    Int      @default(0)
  salesGoal           Int      @default(0)
  salesValueGoal      Float    @default(0)
  revenueGoal         Float    @default(0)
  grossProfitGoal     Float    @default(0)
  reviewsGoal         Int      @default(0)
  marketingSpendGoal  Float    @default(0)

  // Actuals (auto-calculated from daily data)
  leadsActual         Int      @default(0)
  appointmentsActual  Int      @default(0)
  salesActual         Int      @default(0)
  salesValueActual    Float    @default(0)
  revenueActual       Float    @default(0)
  grossProfitActual   Float    @default(0)
  reviewsActual       Int      @default(0)
  marketingSpendActual Float   @default(0)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([month, year])
  @@index([year, month])
}

model OverheadExpense {
  id        String          @id @default(cuid())
  category  OverheadCategory
  name      String
  amount    Float
  month     Int             // 1-12
  year      Int
  isRecurring Boolean       @default(true)
  notes     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([year, month])
  @@index([category])
}

enum OverheadCategory {
  owner_salary
  production_salary
  sales_salary
  admin_salary
  rent
  utilities
  insurance
  software
  vehicles
  equipment
  other
}

model Review {
  id          String       @id @default(cuid())
  rating      Int          // 1-5
  platform    ReviewPlatform @default(google)
  reviewText  String?
  reviewerName String?
  reviewDate  DateTime     @default(now())
  isVerified  Boolean      @default(false)

  // Relations
  jobId       String?
  job         Job?         @relation(fields: [jobId], references: [id])

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([reviewDate])
  @@index([platform])
  @@index([jobId])
}

enum ReviewPlatform {
  google
  yelp
  facebook
  homeadvisor
  angieslist
  nextdoor
  other
}

// ============================================
// SCENARIO PLANNING
// ============================================

model Scenario {
  id                String   @id @default(cuid())
  name              String
  description       String?
  isBaseline        Boolean  @default(false)

  // Input Variables
  leadsCount        Int      @default(0)
  issueRate         Float    @default(0.75)  // Appointments / Leads
  closingRate       Float    @default(0.4)   // Sales / Appointments
  averageSale       Float    @default(4000)
  markupRatio       Float    @default(1.82)  // Price / Cost

  // Marketing
  marketingSpend    Float    @default(0)

  // Cost Structure
  cogsLaborPct      Float    @default(0.32)
  cogsMaterialsPct  Float    @default(0.21)
  cogsOtherPct      Float    @default(0.02)

  // Commissions
  salesCommissionPct Float   @default(0.10)
  pmCommissionPct    Float   @default(0.03)

  // Overhead (annual)
  ownerSalary       Float    @default(0)
  productionSalary  Float    @default(0)
  salesSalary       Float    @default(0)
  adminSalary       Float    @default(0)
  otherOverhead     Float    @default(0)

  // Calculated Results (stored for quick access)
  calculatedRevenue     Float @default(0)
  calculatedGrossProfit Float @default(0)
  calculatedNetProfit   Float @default(0)
  calculatedCPL         Float @default(0)
  calculatedROI         Float @default(0)
  calculatedOwnerTakeHome Float @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isBaseline])
}
